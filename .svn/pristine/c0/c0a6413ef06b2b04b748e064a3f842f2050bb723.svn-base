using Microsoft.EntityFrameworkCore;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Zs.Bot;
using Zs.Bot.DbModel;
using Zs.Common.Enums;
using Zs.Bot.Modules.Command;
using System;
using System.Threading.Tasks;

namespace UnitTest.NETCore
{
    [TestClass]
    public class CommandManagerTests : TestBase
    {
        private readonly CommandManager _commandManager = CommandManager.GetInstance();

        public CommandManagerTests()
        {
            
        }

        /// <summary> Создание команды, помещение её в очередь и вызов из очереди на обработку
        /// НЕ тестируется обработка команды!</summary>
        [TestMethod]
        public async Task CommandQueue_Test()
        {
            try
            {
                // Пришла команда с параметрами от пользователя
                string message = @"/commandName p1 p2, p3;  p4";

                // Создание BotCommand
                var botCommand = await BotCommand.ParseMessageAsync("test", message);

                // Передача команды на обработку
                var cmdMgr = CommandManager.GetInstance();
                cmdMgr.Start();
                var enqueueResult = cmdMgr.EnqueueCommand(botCommand);
                cmdMgr.Stop();

                // На этом этапе сообщение передаётся в другой поток на обработку и тест считаем выполненным
                Assert.IsTrue(enqueueResult);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        /// <summary> Создание и обработка команды без аргументов </summary>
        [TestMethod]
        public async Task CommandProcessNoArgs_Test()
        {
            try
            {
                // Пришла команда от пользователя
                string message = "/Test";

                // Создание BotCommand
                var botCommand = await BotCommand.ParseMessageAsync("test", message);

                var cmdMgr = CommandManager.GetInstance();

                // Передача команды на обработку
                var result = cmdMgr.TEST_RunCommand(botCommand);

                Assert.AreNotEqual(result, $"Command '{botCommand.Name}' running failed!");
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        /// <summary> Создание и обработка команды c аргументами пользователя </summary>
        [TestMethod]
        public async Task CommandProcessUserArgs_Test()
        {
            try
            {
                // Пришла команда с параметрами от пользователя
                string message = "/GetUserStatistics 20 \"'2019-10-29 00:00:00.0+03'\", \"'2019-10-30 00:00:00.0+03'\"; ";

                // Создание BotCommand
                var botCommand = await BotCommand.ParseMessageAsync("test", message);

                var cmdMgr = CommandManager.GetInstance();

                // Передача команды на обработку
                var result = cmdMgr.TEST_RunCommand(botCommand);

                Assert.AreNotEqual(result, $"Command '{botCommand.Name}' running failed!");


            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        /// <summary> Создание и обработка команды c аргументами по умолчанию </summary>
        [TestMethod]
        public async Task CommandProcessDefaultArgs_Test()
        {
            try
            {
                // Пришла команда от пользователя
                string message = "/GetUserStatistics";

                // Создание BotCommand
                var botCommand = await BotCommand.ParseMessageAsync("test", message);

                var cmdMgr = CommandManager.GetInstance();

                // Передача команды на обработку
                var result = cmdMgr.TEST_RunCommand(botCommand);

                Assert.AreNotEqual(result, $"Command '{botCommand.Name}' running failed!");
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }


    }
}
