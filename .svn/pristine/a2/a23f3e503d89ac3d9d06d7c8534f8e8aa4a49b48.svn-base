using System;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using ChatAdminService;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Zs.Bot;
using Zs.Bot.Helpers;
using Zs.Bot.Modules.Agent;
using Zs.Bot.Modules.Messaging;
using Zs.Common.Enums;
using Zs.Common.Interfaces;
using Zs.Common.Modules.Connectors;
using Zs.Service.ChatAdmin.DbModel;

namespace Zs.Service.ChatAdmin
{
    // Todo: Не учитывать стикеры
    // Todo: Разработать механизм оповещения пользователей по графику (добавить столбец с датой последнего оповещения)
    // Todo: Выводить время последних подключений к интернету
    // Todo: Разбить Хелп на группы и выводить только заголовки групп
    // Todo: ПРОВЕРКА СВЯЗИ С БД ПРИ ЗАПУСКЕ БОТА



    internal class ChatAdmin : IHostedService, IDisposable
    {
        //private static DbContextOptionsBuilder<ZsBotContext> _zsBotOptionsBuilder = new DbContextOptionsBuilder<ZsBotContext>();
        private static DbContextOptionsBuilder<ChatAdminContext> _caOptionsBuilder = new DbContextOptionsBuilder<ChatAdminContext>();


        private readonly DateTime _botStartDate = DateTime.Now;      // Время запуска бота
        private DateTime _newDay = DateTime.Today;    // Для определения, начался ли уже новый день
        private bool _chatStatisticsWasSent = false;             // Показывает, была ли сегодня отправлена дневная статистика чата


        /// <summary> Конфигурация из файла </summary>
        private IModuleConfiguration _configuration;

        /// <summary> Модуль для ведения журнала </summary>
        private IZsLogger _logger;

        /// <summary> Бот </summary>
        private ZsBot _bot;

        /// <summary> Модуль для обеспечения подключения к интернету </summary>
        private ConnectionAnalyser _connectionAnalyser;

        /// <summary> Модуль для выполнения заданий по графику </summary>
        private Agent _agent;

        /// <summary> Модуль для анализа/обработки сообщений </summary>
        private MessageProcessor _msgProcessor;


        #region ServiceBase

        public ChatAdmin(ILogger<ChatAdmin> logger)
        {
        }


        public Task StartAsync(CancellationToken cancellationToken)
        {
            OnStart(null);
            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            OnStop();
            return Task.CompletedTask;
        }

        public void OnStart(string[] args)
        {
            _logger        = Logger.GetInstance();
            _configuration = new Configuration("Zs.Service.ChatAdmin.json");
            
            // Инициализация контекста данных
            _caOptionsBuilder.UseNpgsql(_configuration.ConnectionString);
            ChatAdminContext.Initialize(_caOptionsBuilder.Options, _logger);


            // Получение конфигурации из БД
            long   defaultChatId      = -1;
            string botToken           = null;
            string botSessionPassword = null;
            string botProxySocket     = null;
            string botProxyUserName   = null;
            string botProxyPassword   = null;

            using (var casCtx = new ChatAdminContext())
            {
                defaultChatId      = long.Parse(casCtx.Parameters.FirstOrDefault(p => p.Name == "DefaultChatId").Value);
                botToken           = casCtx.Parameters.FirstOrDefault(p => p.Name == "BotToken").Value;
                botSessionPassword = casCtx.Parameters.FirstOrDefault(p => p.Name == "BotSessionPassword").Value;
                botProxyUserName   = casCtx.Parameters.FirstOrDefault(p => p.Name == "ProxyUserName").Value;
                botProxyPassword   = casCtx.Parameters.FirstOrDefault(p => p.Name == "ProxyPassword").Value;
                botProxySocket     = casCtx.Parameters.FirstOrDefault(p => p.Name == "Proxy").Value;
            }

            // Инициализация модулей (потоков)

            _connectionAnalyser = new ConnectionAnalyser(_logger, "https://vk.com/", "https://yandex.ru/", "https://www.google.ru/");
            _connectionAnalyser.InitializeProxy(botProxySocket, botProxyUserName, botProxyPassword);
            _connectionAnalyser.ConnectionStatusChanged += СonnectionAnalyser_StatusChanged;

            IMessenger messenger = null; // Подставляем из инъекции зависимостей

            messenger.Initialize(botToken, botSessionPassword, _connectionAnalyser.WebProxy);

            _bot = ZsBot.CreateNew(_configuration, messenger);
            _bot.Start(1000);

            // СДЕЛАТЬ ПОТОКОМ, ЧТОБЫ ОБРАБОТКА НЕ ТОРМОЗИЛА ОСНОВНОЙ ПОТОК ПРОГРАММЫ
            // В КОТОРОМ РАБОТАЕТ ChatAdmin






#warning У меня полная задница с потоками!!!







            _msgProcessor = new MessageProcessor(_logger, _bot, defaultChatId);
            _msgProcessor.Initialized += MsgProcessor_Initialized;
            _connectionAnalyser.Start(); // Если запустить раньше, то ругнётся на налабл _msgProcessor


            _agent = new Agent(_logger);
            _agent.JobStep = Agent_OnJobStep;
            _agent.JobCycleInterval = 60000;
            _agent.Start();


            //_logger.SaveToDb(LogType.Info, "Запуск службы", "Конец запуска службы", logData);

            // Оповещение владельцев и администраторов о включении бота
            throw new NotImplementedException("Раскомментировать текст ниже после восстановления модели данных");
            //_bot.Messenger.AddMessageToOutbox($"Бот запущен", UserRole.Owner, UserRole.Administrator);
        }

        public void OnStop()
        {
            _agent.Stop();
            _connectionAnalyser.Stop();
            _bot.Stop();
        }
        #endregion


        /// <summary> Обработка события на изменение статуса соединения </summary>
        private void СonnectionAnalyser_StatusChanged(ConnectionStatus status)
        {
            // Переопределяем время восстановления соединения с интернетом 
            // для обработчика сообщения
            if (status == ConnectionStatus.Ok)
                _msgProcessor.SetInternetRepairDate(DateTime.Now);
            else
                _msgProcessor.SetInternetRepairDate(null);
        }

        /// <summary> Обработка события на окончание инициализации обработчика сообщений </summary>
        private void MsgProcessor_Initialized(string currentProcessorConfig)
        {
            throw new NotImplementedException("Раскомментировать текст ниже после восстановления модели данных");

            //// Отправляем сообщение админам
            //foreach (var adminId in ZsBot.GetUsersIdByRole(UserRole.Owner, UserRole.Administrator))
            //    _bot.Messenger.AddMessageToOutbox(adminId, currentProcessorConfig);
        }
        

        /// <summary> Алгоритм автоматической работы (цикл) </summary>
        private void Agent_OnJobStep()
        {
            try
            {
                //DateTime now = DateTime.Now;
                //
                //// При запуске бота пропускаем работу джоба
                //if ((now - _botStartDate) < TimeSpan.FromMinutes(1))
                //{
                //    _logger.SaveToDb(LogType.Info, "Джоб", "При старте бота не выполняем шаги джоба", default(string), null);
                //    return;
                //}
                //
                //// Задачи на начало дня
                //if (now.Date > _newDay.Date)
                //{
                //    _newDay = now.Date;
                //
                //    // 1. Сбрасываем все активные баны
                //    using (var casCtx = new ChatAdminEntities())
                //    {
                //        foreach (var b in casCtx.Bans.Where(b => b.IsActive))
                //        {
                //            b.IsActive = false;
                //            if (b.BanFinishDate?.Date == DateTime.Today)
                //                b.BanFinishDate = now.Date - TimeSpan.FromSeconds(1); // Вероятно, лишнее
                //        }
                //        casCtx.SaveChanges();
                //    }
                //
                //    // 2. Сбрасываем дату учёта сообщений
                //    _accountingStartDate = DateTime.MinValue;
                //
                //    // 3. Задаём значения для ограничений из БД (важно, когда заданные админом значения были сдвинуты, чтобы не перетереть данные)
                //    LoadLimitsFromDb();
                //
                //    // 4. Сбрасываем флаг отправки статистики за день
                //    _chatStatisticsWasSent = false;
                //
                //    _logger.SaveToDb(LogType.Info, "Джоб", "Выполнены задачи на начало дня", default(string));
                //}
                //
                //// Проверка наличия интернета и переопределение лимитов, если интернет был восстановлен после обрыва
                //var connectionStatus = _connector.AnalyzeConnection("https://vk.com/", "https://yandex.ru/", "https://www.google.ru/");
                //if (connectionStatus == ConnectionStatus.Ok)
                //{
                //    if (!_limitsAreDefined && (now - _connector.InternetRepairDate.Value).Minutes >= 1) // и с момента его появления прошла минута
                //    {
                //        // Определение лимитов
                //        LoadLimitsFromDb();
                //        _limitsAreDefined = true; // Не стоит помещать в LoadLimitsFromDb, т.к. когда лимиты сняты админом, этот флаг должен быть всё ещё поднят
                //        SendMessageToAdmins("Лимиты переопределены после восстановления соединения с сервером Telegram");
                //    }
                //    else if (!_limitsAreDefined)
                //        _logger.SaveToDb(LogType.Info, "Джоб", "Соединение восстановленно! Ожидается минута до переопределения лимитов", default(string));
                //}
                //else if (_limitsAreDefined)       // Убираем все лимиты до восстановления подключения и их нового определения
                //{
                //    _limitsAreDefined = false;
                //    _messageLimitHi = -1;
                //}
                //
                //// Запись в ЛОГ, если имеютя проблемы с доступом к серверу Telegram
                //if (connectionStatus == ConnectionStatus.NoInternetConnection)
                //    _logger.SaveToDb(LogType.Warning, "Джоб", "Нет доступа к интернету. Лимиты отключены.", default);
                //else if (connectionStatus == ConnectionStatus.NoProxyConnection)
                //    _logger.SaveToDb(LogType.Warning, "Джоб", "Нет доступа к прокси-серверу. Лимиты отключены.", default);
                //
                //
                //// После 23:55 высылаем статистику
                //if (!_chatStatisticsWasSent && now.Hour == 23 && now.Minute > 55)
                //{
                //    using (var ctx = new ZsBotEntities())
                //    {
                //        string message = "";
                //        string topTenTitle = "\n---\nСамые активные:";
                //
                //        // Формирование сообщения
                //        foreach (var chat in ctx.Chats)
                //        {
                //            var dmuc = GetDailyMessageAndUserCount_OneChat(chat, ctx);
                //            message += (message.Length > 0 && dmuc.Length > 0 ? "\n\n================\n\n" : "");
                //            message += dmuc;
                //            message += GetDailyTopTen_OneChat(chat, ctx, topTenTitle);
                //        }
                //
                //        // Рассылка админам
                //        foreach (var admin in _bot.GetUsersByRole(UserRole.Owner, UserRole.Administrator))
                //        {
                //            var chat = ctx.Chats.FirstOrDefault(c => c.ChatId == admin.UserId)
                //                     ?.GetTelegramType()
                //                     ?.Result;
                //
                //            if (chat != null) // Чат не будет найден, если админ ни разу не писал боту
                //                _bot.Messenger.AddMessageToOutbox(chat, message);
                //        }
                //    }
                //    _chatStatisticsWasSent = true;
                //    _logger.SaveToDb(LogType.Info, "Джоб", $"Отправлена статистика чата за день", default(string));
                //}
                //
                //
                //// Оповещение о сбоях
                //if (now.Minute == 59)
                //{
                //    DateTime dateBeg = DateTime.MaxValue;
                //
                //    // Если с 11:00 до 23:00, то собираем ошибки за час
                //    if (now.Hour > 9) // == 10:59
                //        dateBeg = now - TimeSpan.FromHours(1);
                //
                //    // Если 10:00, то собираем ошибки за прошлые 11 часов
                //    if (now.Hour == 9) // == 09:59
                //        dateBeg = now - TimeSpan.FromHours(11);
                //
                //    var logErrors = _logger.GetLog(LogType.Error, dateBeg, now);
                //    var logWarnings = _logger.GetLog(LogType.Warning, dateBeg, now);
                //
                //    // Формирование сообщения
                //    if (logErrors?.Count > 0 || logWarnings?.Count > 0)
                //    {
                //        string message = $"*Всего сбоев: {logErrors.Count}*";
                //        logErrors.ForEach(e => message += $"\n\n{e}");
                //
                //        message += $"\n\n\n*Всего предупреждений: {logWarnings.Count}*";
                //        logWarnings.ForEach(w => message += $"\n\n{w}");
                //
                //        // Обрезаем сообщение, если оно очень большое
                //        if (message.Length > 1200)
                //            message = message.Substring(0, 1197) + "...";
                //
                //        SendMessageToAdmins(message.Trim());
                //    }
                //}
                //
                //
                //// Оповещение о событиях
                //using (var casCtx = new ChatAdminEntities())
                //{
                //    var notifications = casCtx.Notifications
                //         .Where(n => n.NotificationIsActive
                //                  && (n.NotificationMonth == null || n.NotificationMonth == DateTime.Now.Month)
                //                  && n.NotificationDay == DateTime.Today.Day
                //                  && n.NotificationHour == DateTime.Now.Hour
                //                  && (n.NotificationMinute == DateTime.Now.Minute // та же минута или в промежутке от этой минуты до +2 минут
                //                      || (n.NotificationMinute > DateTime.Now.Minute && n.NotificationMinute < (DateTime.Now + TimeSpan.FromMinutes(2)).Minute))
                //                  && (n.NotificationLastExecDate == null
                //                      || n.NotificationLastExecDate.Value.Date != DateTime.Today)).ToList();
                //
                //    foreach (var n in notifications)
                //    {
                //        var chat = Zs.Bot.DbModel.DbChat.GetChatById(_defaultChatId);
                //        _bot.Messenger.AddMessageToOutbox(chat, n.NotificationMessage);
                //
                //        n.NotificationLastExecDate = DateTime.Now;
                //    }
                //
                //    if (notifications.Count() > 0)
                //        casCtx.SaveChanges();
                //}
            }
            catch (Exception ex)
            {
                _logger.SaveException(ex);
                //_logger.SaveToDb("ОШИБКА! Выполнение джоба", ex);
            }
            finally
            {
                //_logger.SaveToDb(LogType.Info, "Джоб", "Выполнение джоба закончилось", default(string), null);
            }
        }


        public void Dispose()
        {
            Console.WriteLine("Disposing...");
        }

    }
}
