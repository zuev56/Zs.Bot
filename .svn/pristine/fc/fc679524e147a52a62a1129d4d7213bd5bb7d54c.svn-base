using System;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Zs.Common.Enums;
using Zs.Common.Modules.Connectors;

namespace Zs.UnitTest.Bot
{
    [TestClass]
    public class ConnectionAnalyzerTest// : TestBase
    {

        // Эта пременная должна покажет, что произошёл вызов события ConnectionStatusChanged
        private ConnectionStatus _changedStatus;

        public ConnectionAnalyzerTest()
        {
            // TODO: Вынести тестовые данные прокси в файл конфигурации!
            
        }

        [TestMethod]
        public async Task LoopWork_Test()
        {
            try
            {
                 var analyser = new ConnectionAnalyser("https://vk.com/", "https://yandex.ru/", "https://www.google.ru/");
                analyser.InitializeProxy("123.123.123.123:12345", "userName", "password");
                analyser.ConnectionStatusChanged += StatusChanged;
                
                Exception exception = null;
                await Task.Run(async () =>
                {
                    analyser.Start(100, 2000); 
                    await Task.Delay(3000);
                    _changedStatus = ConnectionStatus.Undefined;
                    for (int i = 0; i < 100; i++)
                    {
                        await Task.Delay(500);
                        if (_changedStatus != ConnectionStatus.Undefined)
                        {
                            analyser.Stop();
                            analyser.ConnectionStatusChanged -= StatusChanged;
                            break;
                        }
                    }
                }).ContinueWith(task => exception = task.Exception);

                if (exception != null)
                    throw exception;

                Assert.IsTrue(_changedStatus != ConnectionStatus.Undefined);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        [TestMethod]
        public void PingHost_Test()
        {
            try
            {
                Thread.Sleep(2000);

                Assert.IsTrue(ConnectionAnalyser.PingHost("localhost"));
                Assert.IsTrue(ConnectionAnalyser.PingHost("https://vk.com/"));
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private void StatusChanged(ConnectionStatus newConnectionStatus)
        {
            _changedStatus = newConnectionStatus;
        }


    }
}
