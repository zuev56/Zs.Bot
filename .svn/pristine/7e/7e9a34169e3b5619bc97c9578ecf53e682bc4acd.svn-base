using System;
using System.Threading;
using System.Threading.Tasks;
using ChatAdminService;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Hosting;
using Zs.Bot;
using Zs.Bot.Helpers;
using Zs.Bot.Modules.Agent;
using Zs.Bot.Modules.Messaging;
using Zs.Common.Enums;
using Zs.Common.Interfaces;
using Zs.Common.Modules.Connectors;
using Zs.Service.ChatAdmin.DbModel;

namespace Zs.Service.ChatAdmin
{
    // Todo: Не учитывать стикеры
    // Todo: Разработать механизм оповещения пользователей по графику (добавить столбец с датой последнего оповещения)
    // Todo: Выводить время последних подключений к интернету
    // Todo: Разбить Хелп на группы и выводить только заголовки групп
    // Todo: ПРОВЕРКА СВЯЗИ С БД ПРИ ЗАПУСКЕ БОТА



    internal class ChatAdmin : IHostedService, IDisposable
    {
        private readonly IZsConfiguration _configuration;
        private readonly IZsLogger _logger;

        private readonly ZsBot _bot;
        //private readonly Agent _agent;
        private readonly MessageProcessor _msgProcessor;
        private readonly ConnectionAnalyser _connectionAnalyser;


        #region ServiceBase

        public ChatAdmin(
            IZsConfiguration configuration,
            IMessenger messenger, 
            ConnectionAnalyser connectionAnalyser)
        {
            _logger = Logger.GetInstance();
            _configuration = configuration;
            
            _bot = new ZsBot(_configuration, messenger);

            _connectionAnalyser = connectionAnalyser;
            _connectionAnalyser.ConnectionStatusChanged += СonnectionAnalyser_StatusChanged;
            
            _msgProcessor = new MessageProcessor(_bot, default);
            _msgProcessor.Initialized += MsgProcessor_Initialized;
            
            //_agent = new Agent();
            //_agent.JobStep = Agent_OnJobStep;
            //_agent.JobCycleInterval = 60000;

            var optionsBuilder = new DbContextOptionsBuilder<ChatAdminDbContext>();
            optionsBuilder.UseNpgsql(_configuration.ConnectionString);
            ChatAdminDbContext.Initialize(optionsBuilder.Options);
        }

        public Task StartAsync(CancellationToken cancellationToken)
        {
            _connectionAnalyser.Start(5000, 30000);
            _bot.Messenger.AddMessageToOutbox($"Бот запущен", "ADMIN");
            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            _connectionAnalyser.Stop();
            return Task.CompletedTask;
        }
        #endregion


        private void СonnectionAnalyser_StatusChanged(ConnectionStatus status)
        {
            // Переопределяем время восстановления соединения с интернетом 
            // для обработчика сообщения
            //if (status == ConnectionStatus.Ok)
            //    _msgProcessor.SetInternetRepairDate(DateTime.Now);
            //else
            //    _msgProcessor.SetInternetRepairDate(null);
        }

        private void MsgProcessor_Initialized(string currentProcessorConfig)
        {
            throw new NotImplementedException("Раскомментировать текст ниже после восстановления модели данных");
        }
        

        /// <summary> Алгоритм автоматической работы (цикл) </summary>
        private void Agent_OnJobStep()
        {
            try
            {
                //DateTime now = DateTime.Now;
                //
                //// При запуске бота пропускаем работу джоба
                //if ((now - _botStartDate) < TimeSpan.FromMinutes(1))
                //{
                //    _logger.SaveToDb(LogType.Info, "Джоб", "При старте бота не выполняем шаги джоба", default(string), null);
                //    return;
                //}
                //
                //// Задачи на начало дня
                //if (now.Date > _newDay.Date)
                //{
                //    _newDay = now.Date;
                //
                //    // 1. Сбрасываем все активные баны
                //    using (var casCtx = new ChatAdminEntities())
                //    {
                //        foreach (var b in casCtx.Bans.Where(b => b.IsActive))
                //        {
                //            b.IsActive = false;
                //            if (b.BanFinishDate?.Date == DateTime.Today)
                //                b.BanFinishDate = now.Date - TimeSpan.FromSeconds(1); // Вероятно, лишнее
                //        }
                //        casCtx.SaveChanges();
                //    }
                //
                //    // 2. Сбрасываем дату учёта сообщений
                //    _accountingStartDate = DateTime.MinValue;
                //
                //    // 3. Задаём значения для ограничений из БД (важно, когда заданные админом значения были сдвинуты, чтобы не перетереть данные)
                //    LoadLimitsFromDb();
                //
                //    // 4. Сбрасываем флаг отправки статистики за день
                //    _chatStatisticsWasSent = false;
                //
                //    _logger.SaveToDb(LogType.Info, "Джоб", "Выполнены задачи на начало дня", default(string));
                //}
                //
                //// Проверка наличия интернета и переопределение лимитов, если интернет был восстановлен после обрыва
                //var connectionStatus = _connector.AnalyzeConnection("https://vk.com/", "https://yandex.ru/", "https://www.google.ru/");
                //if (connectionStatus == ConnectionStatus.Ok)
                //{
                //    if (!_limitsAreDefined && (now - _connector.InternetRepairDate.Value).Minutes >= 1) // и с момента его появления прошла минута
                //    {
                //        // Определение лимитов
                //        LoadLimitsFromDb();
                //        _limitsAreDefined = true; // Не стоит помещать в LoadLimitsFromDb, т.к. когда лимиты сняты админом, этот флаг должен быть всё ещё поднят
                //        SendMessageToAdmins("Лимиты переопределены после восстановления соединения с сервером Telegram");
                //    }
                //    else if (!_limitsAreDefined)
                //        _logger.SaveToDb(LogType.Info, "Джоб", "Соединение восстановленно! Ожидается минута до переопределения лимитов", default(string));
                //}
                //else if (_limitsAreDefined)       // Убираем все лимиты до восстановления подключения и их нового определения
                //{
                //    _limitsAreDefined = false;
                //    _messageLimitHi = -1;
                //}
                //
                //// Запись в ЛОГ, если имеютя проблемы с доступом к серверу Telegram
                //if (connectionStatus == ConnectionStatus.NoInternetConnection)
                //    _logger.SaveToDb(LogType.Warning, "Джоб", "Нет доступа к интернету. Лимиты отключены.", default);
                //else if (connectionStatus == ConnectionStatus.NoProxyConnection)
                //    _logger.SaveToDb(LogType.Warning, "Джоб", "Нет доступа к прокси-серверу. Лимиты отключены.", default);
                //
                //
                //// После 23:55 высылаем статистику
                //if (!_chatStatisticsWasSent && now.Hour == 23 && now.Minute > 55)
                //{
                //    using (var ctx = new ZsBotEntities())
                //    {
                //        string message = "";
                //        string topTenTitle = "\n---\nСамые активные:";
                //
                //        // Формирование сообщения
                //        foreach (var chat in ctx.Chats)
                //        {
                //            var dmuc = GetDailyMessageAndUserCount_OneChat(chat, ctx);
                //            message += (message.Length > 0 && dmuc.Length > 0 ? "\n\n================\n\n" : "");
                //            message += dmuc;
                //            message += GetDailyTopTen_OneChat(chat, ctx, topTenTitle);
                //        }
                //
                //        // Рассылка админам
                //        foreach (var admin in _bot.GetUsersByRole(UserRole.Owner, UserRole.Administrator))
                //        {
                //            var chat = ctx.Chats.FirstOrDefault(c => c.ChatId == admin.UserId)
                //                     ?.GetTelegramType()
                //                     ?.Result;
                //
                //            if (chat != null) // Чат не будет найден, если админ ни разу не писал боту
                //                _bot.Messenger.AddMessageToOutbox(chat, message);
                //        }
                //    }
                //    _chatStatisticsWasSent = true;
                //    _logger.SaveToDb(LogType.Info, "Джоб", $"Отправлена статистика чата за день", default(string));
                //}
                //
                //
                //// Оповещение о сбоях
                //if (now.Minute == 59)
                //{
                //    DateTime dateBeg = DateTime.MaxValue;
                //
                //    // Если с 11:00 до 23:00, то собираем ошибки за час
                //    if (now.Hour > 9) // == 10:59
                //        dateBeg = now - TimeSpan.FromHours(1);
                //
                //    // Если 10:00, то собираем ошибки за прошлые 11 часов
                //    if (now.Hour == 9) // == 09:59
                //        dateBeg = now - TimeSpan.FromHours(11);
                //
                //    var logErrors = _logger.GetLog(LogType.Error, dateBeg, now);
                //    var logWarnings = _logger.GetLog(LogType.Warning, dateBeg, now);
                //
                //    // Формирование сообщения
                //    if (logErrors?.Count > 0 || logWarnings?.Count > 0)
                //    {
                //        string message = $"*Всего сбоев: {logErrors.Count}*";
                //        logErrors.ForEach(e => message += $"\n\n{e}");
                //
                //        message += $"\n\n\n*Всего предупреждений: {logWarnings.Count}*";
                //        logWarnings.ForEach(w => message += $"\n\n{w}");
                //
                //        // Обрезаем сообщение, если оно очень большое
                //        if (message.Length > 1200)
                //            message = message.Substring(0, 1197) + "...";
                //
                //        SendMessageToAdmins(message.Trim());
                //    }
                //}
                //
                //
                //// Оповещение о событиях
                //using (var casCtx = new ChatAdminEntities())
                //{
                //    var notifications = casCtx.Notifications
                //         .Where(n => n.NotificationIsActive
                //                  && (n.NotificationMonth == null || n.NotificationMonth == DateTime.Now.Month)
                //                  && n.NotificationDay == DateTime.Today.Day
                //                  && n.NotificationHour == DateTime.Now.Hour
                //                  && (n.NotificationMinute == DateTime.Now.Minute // та же минута или в промежутке от этой минуты до +2 минут
                //                      || (n.NotificationMinute > DateTime.Now.Minute && n.NotificationMinute < (DateTime.Now + TimeSpan.FromMinutes(2)).Minute))
                //                  && (n.NotificationLastExecDate == null
                //                      || n.NotificationLastExecDate.Value.Date != DateTime.Today)).ToList();
                //
                //    foreach (var n in notifications)
                //    {
                //        var chat = Zs.Bot.DbModel.DbChat.GetChatById(_defaultChatId);
                //        _bot.Messenger.AddMessageToOutbox(chat, n.NotificationMessage);
                //
                //        n.NotificationLastExecDate = DateTime.Now;
                //    }
                //
                //    if (notifications.Count() > 0)
                //        casCtx.SaveChanges();
                //}
            }
            catch (Exception ex)
            {
                _logger.LogError(ex);
                //_logger.SaveToDb("ОШИБКА! Выполнение джоба", ex);
            }
            finally
            {
                //_logger.SaveToDb(LogType.Info, "Джоб", "Выполнение джоба закончилось", default(string), null);
            }
        }


        public void Dispose()
        {
            Console.WriteLine("Disposing...");
        }

    }
}
