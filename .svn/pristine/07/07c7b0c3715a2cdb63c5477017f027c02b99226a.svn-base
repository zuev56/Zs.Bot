


CREATE TABLE rmgr."Chat" (
    "ChatId"                          bigserial    PRIMARY KEY,
    "ChatTitle"                       varchar(50)      NULL,
    "ChatFirstName"                   varchar(50)      NULL,
    "ChatLastName"                    varchar(50)      NULL,
    "ChatDescription"                 varchar(100)     NULL,
    "ChatType"                        varchar(50)      NULL,
    "ChatInviteLink"                  varchar(10)      NULL,
    "ChatUserName"                    varchar(50)      NULL,
    "ChatAllMembersAreAdministrators" bool             NULL,
    "ChatCanSetStickerSet"            bool             NULL,
    "ChatStickerSetName"              varchar(50)      NULL,
    "PinnedMessageId"                 int              NULL,

    "IsSubscribed"                    bool         NOT NULL,
    "InsertDate"                      timestamptz  NOT NULL DEFAULT now(),	
    "UpdateDate"                      timestamptz  NOT NULL DEFAULT now()
);
CREATE TRIGGER "Chat_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Chat" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."Role" (
    "RoleName"   varchar(50)  PRIMARY KEY,
    "UpdateDate" timestamptz  NOT NULL DEFAULT now(),
    "InsertDate" timestamptz  NOT NULL DEFAULT now()
);
CREATE TRIGGER "Role_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Role" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();

INSERT INTO rmgr."Role"("RoleName") VALUES('Administrator');
INSERT INTO rmgr."Role"("RoleName") VALUES('Moderator');
INSERT INTO rmgr."Role"("RoleName") VALUES('User');




CREATE TABLE rmgr."User" (
    "UserId"         serial      PRIMARY KEY,
    "UserName"       varchar(50)     NULL,
    "UserManualName" varchar(50)     NULL,
    "UserFirstName"  varchar(50)     NULL,
    "UserLastName"   varchar(50)     NULL,
    "RoleName"       varchar(50) NOT NULL REFERENCES rmgr."Role"("RoleName"),
    "IsBot"          bool            NULL,
    "UpdateDate"     timestamptz NOT NULL DEFAULT now(),
    "InsertDate"     timestamptz NOT NULL DEFAULT now()
);
CREATE TRIGGER "User_UpdateDate_reset" BEFORE UPDATE
ON rmgr."User" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."MessageType" (
    "MessageTypeName" varchar(50)  PRIMARY KEY,
    "InsertDate"      timestamptz  NOT NULL DEFAULT now(),	
    "UpdateDate"      timestamptz  NOT NULL DEFAULT now()
);
CREATE TRIGGER "MessageType_UpdateDate_reset" BEFORE UPDATE
ON rmgr."MessageType" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();

INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Unknown');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Text');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Photo');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Audio');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Video');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Voice');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Document');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Sticker');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Location');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Contact');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Venue');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Game');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('VideoNote');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Invoice');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('SuccessfulPayment');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('WebsiteConnected');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChatMembersAdded');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChatMemberLeft');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChatTitleChanged');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChatPhotoChanged');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('MessagePinned');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChatPhotoDeleted');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('GroupCreated');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('SupergroupCreated');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('ChannelCreated');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('MigratedToSupergroup');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('MigratedFromGroup');
INSERT INTO rmgr."MessageType"("MessageTypeName") VALUES('Animation');




CREATE TABLE rmgr."ReceivedMsg" (
    "ReceivedMsgId"                     bigserial     PRIMARY KEY,
    "ReceivedMsgMessageId"              int           NOT NULL,
    "UserId"                            int           NOT NULL REFERENCES rmgr."User" ("UserId"),
    "ChatId"				            bigint        NOT NULL REFERENCES rmgr."Chat" ("ChatId"),
    "MessageTypeName"                   varchar(50)   NOT NULL REFERENCES rmgr."MessageType" ("MessageTypeName"),
    "ReceivedMsgAuthorSignature"		varchar(500)      NULL,
    "ReceivedMsgCaption"				varchar(500)      NULL,
    "ReceivedMsgChannelChatCreated"     bool              NULL,
    "ReceivedMsgConnectedWebsite"		varchar(500)      NULL,
    "ReceivedMsgDate"					timestamptz       NULL,
    "ReceivedMsgDeleteChatPhoto"		bool              NULL,
    "ReceivedMsgEditDate"				timestamptz       NULL,
    "ReceivedMsgForwardDate"			timestamptz       NULL,
    "ReceivedMsgForwardFromId"          int               NULL,
    "ReceivedMsgForwardFromChatId"      bigint            NULL,
    "ReceivedMsgForwardFromMessageId"   int               NULL,
    "ReceivedMsgForwardSignature"       varchar(500)      NULL,
    "ReceivedMsgGroupChatCreated"       bool              NULL,
    --"ReceivedMsgIsForwarded"            bool              NULL,
    "ReceivedMsgLeftChatMemberId"       int               NULL,
    "ReceivedMsgLocation"               varchar(500)      NULL,
    "ReceivedMsgMediaGroupId"           varchar(500)      NULL,
    "ReceivedMsgMigrateFromChatId"      bigint            NULL,
    "ReceivedMsgMigrateToChatId"        bigint            NULL,
    "ReceivedMsgNewChatTitle"           varchar(500)      NULL,
    "ReceivedMsgPinnedMessageId"        int               NULL,
    "ReceivedMsgReplyToMessageId"       int               NULL,
    "ReceivedMsgSupergroupChatCreated"  bool              NULL,
    "ReceivedMsgText"                   varchar(5000)     NULL,
    "IsDeleted"                         bool          NOT NULL DEFAULT(false),
    "InsertDate"                        timestamptz   NOT NULL DEFAULT now(),	
    "UpdateDate"                        timestamptz   NOT NULL DEFAULT now()
);
CREATE TRIGGER "ReceivedMsg_UpdateDate_reset" BEFORE UPDATE
ON rmgr."ReceivedMsg" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."SentMsg" (
    "SentMsgId"                     serial     PRIMARY KEY,
    "ChatId"				        bigint        NOT NULL REFERENCES rmgr."Chat" ("ChatId"),
    "SentMsgMessageId"				int               NULL,
    "SentMsgText" 					varchar(5000)     NULL,
    "MessageTypeName"               varchar(50)   NOT NULL REFERENCES rmgr."MessageType" ("MessageTypeName"),
     
    "SentMsgParseMode"              varchar(100)      NULL,
    "SentMsgDisableWebPagePreview"  bool              NULL,
    "SentMsgDisableNotification"    bool              NULL,
    "SentMsgReplyToMessageId"       int               NULL,
    "SentMsgCaption"                varchar(500)      NULL,
    "SentMsgDuration"               int               NULL,
    "SentMsgPerformer"              varchar(500)      NULL,
    "SentMsgTitle"                  varchar(500)      NULL,
    "SentMsgWidth"                  int               NULL,
    "SentMsgHeight"                 int               NULL,
    "SentMsgSupportsStreaming"      bool              NULL,
    "SentMsgLength"                 int               NULL,
    "SentMsgLatitude"               float             NULL,
    "SentMsgLongitude"              float             NULL,
    "SentMsgLivePeriod"             int               NULL,
    "SentMsgAddress"                varchar(100)      NULL,
    "SentMsgFoursquareId"           varchar(100)      NULL,
    "SentMsgFoursquareType"         varchar(100)      NULL,
    "SentMsgPhoneNumber"            varchar(100)      NULL,
    "SentMsgFirstName"              varchar(100)      NULL,
    "SentMsgLastName"               varchar(100)      NULL,
    "SentMsgVCard"                  varchar(500)      NULL,
    
    "SentMsgTag"    	        	varchar(5000)     NULL,
    "SentMsgKeyboardType"    		varchar(20)       NULL,
    "SentMsgFailedSendings"  		int               NULL,
    "SentMsgFailDescription" 		varchar(5000)     NULL,
    "SentMsgReplyToMessageId"		int				  NULL,
    "IsSentSuccessfully"            bool              NULL,	
    "IsDeleted"                     bool          NOT NULL DEFAULT(false),
    "InsertDate"             		timestamptz   NOT NULL DEFAULT now(),	
    "UpdateDate"             		timestamptz   NOT NULL DEFAULT now()
);
CREATE TRIGGER "SentMsg_UpdateDate_reset" BEFORE UPDATE
ON rmgr."SentMsg" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."Session" (
    "SessionId"          serial      PRIMARY KEY,
    "ChatId"             bigint      NOT NULL REFERENCES rmgr."Chat" ("ChatId"),
    "SessionIsLoggedIn"  bool        NOT NULL,
    "SessionCurrentStep" varchar(50)     NULL,
    "InsertDate"         timestamptz NOT NULL DEFAULT now(),	
    "UpdateDate"         timestamptz NOT NULL DEFAULT now()
);
CREATE TRIGGER "Session_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Session" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."Log" (
    "LogId"      serial        PRIMARY KEY,
    "LogType"    varchar(50)       NULL,
    "LogGroup"   varchar(50)       NULL,
    "LogMessage" varchar(5000)     NULL,
    "LogData"    varchar(5000)     NULL,
    "LogMethod"  varchar(100)      NULL,
    "MessageId"  int               NULL,
    "UpdateDate" timestamptz   NOT NULL DEFAULT now(),
    "InsertDate" timestamptz   NOT NULL DEFAULT now()
);
CREATE TRIGGER "Log_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Log" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."Job" (
    "JobId"           serial        PRIMARY KEY,
    "JobName"         varchar(100)  NOT NULL,
    "JobDescription"  varchar(100)      NULL,	
    "JobIsActive"     bool          NOT NULL DEFAULT FALSE,
    "JobMethodName"   varchar(100)  NOT NULL,
    "JobMonth"        int               NULL, -- месяц, если событие ежегодное; null, если событие ежемесячное
    "JobDay"          int           NOT NULL, -- день месяца
    "JobHour"         int           NOT NULL, -- время оповещения
    "JobMinute"       int           NOT NULL, -- время оповещения
    "JobLastExecDate" timestamptz       NULL,
    "UpdateDate"      timestamptz   NOT NULL DEFAULT now(),
    "InsertDate"      timestamptz   NOT NULL DEFAULT now()
);
CREATE TRIGGER "Job_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Job" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();




CREATE TABLE rmgr."Command" (
    "CommandName"        varchar(30)   PRIMARY KEY,
    "CommandScript"      varchar(5000) NOT NULL, -- SQL-скрипт с параметрами    
    "CommandDefaultArgs" varchar(100)      NULL, -- Дефолтные аргументы, которые будут вызванны при вызове команды без аргументов. Записываются через точку с запятой
    "CommandDesc"        varchar(100)      NULL,
    "RoleList"           varchar(100)  NOT NULL,
    "UpdateDate"         timestamptz   NOT NULL DEFAULT now(),
    "InsertDate"         timestamptz   NOT NULL DEFAULT now()
);
CREATE TRIGGER "Command_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Command" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();

INSERT INTO rmgr."Command"("CommandName", "CommandScript", "CommandDefaultArgs", "CommandDesc", "RoleList") 
VALUES('/GetUserStatistics', 'SELECT rmgr."sfCmdGetStatistics"({0}, {1}, {2})', '15; now()::Date; now()', 'Получение статистики по активности участников чата за определённый период', 'Administrator');
INSERT INTO rmgr."Command"("CommandName", "CommandScript", "CommandDefaultArgs", "CommandDesc", "RoleList") 
VALUES('/Test', 'SELECT ''Test''', null, 'Тестовый запрос к боту', 'Administrator');
INSERT INTO rmgr."Command"("CommandName", "CommandScript", "CommandDefaultArgs", "CommandDesc", "RoleList") 
VALUES('/Help', 'SELECT rmgr."sfCmdGetHelp"({0})', '''User''', 'Получение справки по функциям, доступным для данной роли', 'User; Administrator');
INSERT INTO rmgr."Command"("CommandName", "CommandScript", "CommandDefaultArgs", "CommandDesc", "RoleList") 
VALUES('/SetMessageLimit', 'SELECT rmgr."sfCmdSetMessageLimit"({0}, {1})', '0; 0', 'Установка лимита сообщений для пользователей', 'Administrator');

-- Проверка и правка имени команды 
CREATE OR REPLACE FUNCTION rmgr."Command_CommandName_correct"()
RETURNS TRIGGER AS $$
BEGIN
    -- Trim and lower
    NEW."CommandName" = lower(trim(NEW."CommandName"));

    -- Add '/'	
    NEW."CommandName" := REPLACE(NEW."CommandName", '/', '' );
    NEW."CommandName" := '/' || NEW."CommandName";
    
    --raise notice 'Value: %', NEW."CommandName";
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER "Command_CommandName_correct" BEFORE INSERT
ON rmgr."Command" FOR EACH ROW EXECUTE PROCEDURE rmgr."Command_CommandName_correct"();

CREATE TRIGGER "Ban_UpdateDate_reset" BEFORE UPDATE
ON rmgr."Command" FOR EACH ROW EXECUTE PROCEDURE helper."UpdateDate_reset"();



